<!DOCTYPE html>
<html>
<head>
  <title>Web Polls</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <style>
    ul#polls {
      list-style: none;
      padding: 0;
    }
  </style>
</head>
<body>
  <div class="jumbotron">
    <div class="container">
      <h1>Web Polls</h1>
      <p>Welcome to the future of democracy</p>
      <a href="new.html" class="btn btn-primary btn-lg">New Poll</a>
    </div>
  </div>
  <div class="container">
      <ul id="polls"></ul>
  </div>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script>

    var pollsEl;
    function update() {
      $.ajax("/polls.json", {
        dataType:"json",
        success:function(polls) {
          for (i in polls) {
            var poll = polls[i];
            var elId = poll["_id"];
            var el = pollsEl.find("#"+elId);
            if (el.size() == 0) {
              el = $("<li class='poll panel panel-default'>")
                .attr("id", elId)
                .append(
                  $("<div class='panel-heading'>").append(
                    $("<h3 class='panel-title'/>")
                  ),
                  $("<div class='panel-body'>").append(
                    $("<img>"),
                    $("<ul/>")
                  ),
                  $("<div class='panel-footer'>").append(
                    $("<button class='btn btn-danger btn-xs'></button>")
                      .html("<span class='glyphicon glyphicon-remove'></span> Delete Poll")
                      .click(function(){
                        var id = $(this).closest("li").attr("id");
                        if (confirm("Are you sure you want to delete this poll?")) {
                          $.ajax("/polls/" + id, {
                            method: "DELETE",
                            success: function(){
                              location.reload();
                            }
                          })
                        }
                      }
                    )
                  )
                )
                .appendTo(pollsEl)
              ;
            }
            var data = chartData(poll);
            el.find("h3").text(poll["title"] + " (" + data.total + ")");
            el.find("img").attr("src", data.img);
            var options = "";
            for (var o in poll.options) {
              var opt = poll.options[o];
              if (poll.results && poll.results[opt]) {
                options += "<li>" + opt + ": " + poll.results[opt] + "</li>";
              } else {
                options += "<li>" + opt + ": 0</li>";
              }
            }
            el.find("ul").html(options);
          }
          window.setTimeout(update, 1000);
        }}
      );
    }

    function chartData(poll) {
      var results = poll["results"];
      var chd = [], chl = [];
      var total = 0;
      for (var option in results) {
        if (option[0] == "_") continue;
        total += results[option];
      }
      for (var option in results) {
        if (option[0] == "_") continue;
        chd.push(Math.floor(100 / (total / results[option])));
        chl.push(option);
      }
      return {
        total: total,
        img: "https://chart.googleapis.com/chart?chds=a&cht=p&chs=500x300&chd=t:" + chd.join(",") + "&chl=" + chl.join("|") + "&chco=000000"
      }
    }

    $(function(){
      pollsEl = $("#polls");
      update();
    });

  </script>
</body>
</html>